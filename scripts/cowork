#!/bin/bash
#
# cowork - CLI wrapper for Cowork Sandbox
# Simplifies interaction with Claude Code running in Lima VM
#

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"
VM_NAME="${COWORK_VM_NAME:-sandbox}"
WORKSPACE="${COWORK_WORKSPACE:-/workspace}"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

print_header() {
    echo -e "${BLUE}╭─────────────────────────────────────╮${NC}"
    echo -e "${BLUE}│      Cowork Sandbox Controller      │${NC}"
    echo -e "${BLUE}╰─────────────────────────────────────╯${NC}"
}

print_success() {
    echo -e "${GREEN}✓${NC} $1"
}

print_error() {
    echo -e "${RED}✗${NC} $1" >&2
}

print_info() {
    echo -e "${YELLOW}→${NC} $1"
}

# Check if Lima is installed
check_lima() {
    if ! command -v limactl &> /dev/null; then
        print_error "Lima is not installed. Install with: brew install lima"
        exit 1
    fi
}

# Check VM status
vm_status() {
    # Lima 2.x outputs a single JSON object, not an array
    # Try new format first, then fall back to old format for compatibility
    local status
    status=$(limactl list --json 2>/dev/null | jq -r "if type == \"array\" then .[] | select(.name == \"$VM_NAME\") | .status else if .name == \"$VM_NAME\" then .status else empty end end" 2>/dev/null)
    if [ -z "$status" ]; then
        echo "NotFound"
    else
        echo "$status"
    fi
}

# Initialize/Create VM
cmd_init() {
    check_lima

    print_header
    print_info "Initializing Cowork Sandbox VM..."

    # Check if VM already exists
    local status=$(vm_status)
    if [ "$status" != "NotFound" ]; then
        print_info "VM '$VM_NAME' already exists (status: $status)"
        if [ "$status" != "Running" ]; then
            print_info "Starting VM..."
            limactl start "$VM_NAME"
        fi
    else
        # Create workspace directory on host
        mkdir -p "$HOME/cowork-workspace"

        # Create VM from config
        print_info "Creating VM from sandbox.yaml..."
        limactl start --name="$VM_NAME" "$PROJECT_DIR/sandbox.yaml"
    fi

    print_success "VM initialized successfully!"

    # Show status
    cmd_status
}

# Start VM
cmd_start() {
    check_lima

    local status=$(vm_status)
    if [ "$status" == "Running" ]; then
        print_info "VM is already running"
    elif [ "$status" == "NotFound" ]; then
        print_error "VM not found. Run 'cowork init' first."
        exit 1
    else
        print_info "Starting VM..."
        limactl start "$VM_NAME"
        print_success "VM started"
    fi
}

# Stop VM
cmd_stop() {
    check_lima

    print_info "Stopping VM..."
    limactl stop "$VM_NAME" 2>/dev/null || true
    print_success "VM stopped"
}

# Show VM status
cmd_status() {
    check_lima

    print_header

    local status=$(vm_status)
    echo ""
    echo "VM Status:"
    echo "  Name:   $VM_NAME"
    echo "  Status: $status"

    if [ "$status" == "Running" ]; then
        echo ""
        echo "Environment:"
        echo "  Python: $(limactl shell "$VM_NAME" -- python3 --version 2>/dev/null | cut -d' ' -f2)"
        echo "  Node:   $(limactl shell "$VM_NAME" -- node --version 2>/dev/null)"
        echo "  Claude: $(limactl shell "$VM_NAME" -- claude --version 2>/dev/null || echo 'not installed')"
        echo ""
        echo "Workspace: $WORKSPACE"
        echo "  Files: $(limactl shell "$VM_NAME" -- ls "$WORKSPACE" 2>/dev/null | wc -l | tr -d ' ') items"
    fi
    echo ""
}

# Enter VM shell
cmd_shell() {
    check_lima

    local status=$(vm_status)
    if [ "$status" != "Running" ]; then
        print_error "VM is not running. Run 'cowork start' first."
        exit 1
    fi

    print_info "Entering VM shell (exit with 'exit' or Ctrl+D)..."
    limactl shell "$VM_NAME"
}

# Run Claude interactively in VM
cmd_claude() {
    check_lima

    local status=$(vm_status)
    if [ "$status" != "Running" ]; then
        print_error "VM is not running. Run 'cowork start' first."
        exit 1
    fi

    # Determine actual workspace path in VM
    local vm_workspace="$WORKSPACE"
    if ! limactl shell "$VM_NAME" -- test -d "$WORKSPACE" 2>/dev/null; then
        # Fallback to home-mounted cowork-workspace
        vm_workspace="$HOME/cowork-workspace"
    fi

    print_info "Starting Claude Code in VM..."
    # Build environment variables for Claude API
    local env_vars=""
    if [ -n "$ANTHROPIC_AUTH_TOKEN" ]; then
        env_vars="ANTHROPIC_AUTH_TOKEN='$ANTHROPIC_AUTH_TOKEN' "
    fi
    if [ -n "$ANTHROPIC_BASE_URL" ]; then
        env_vars="${env_vars}ANTHROPIC_BASE_URL='$ANTHROPIC_BASE_URL' "
    fi
    limactl shell "$VM_NAME" -- bash -c "cd $vm_workspace && ${env_vars}claude --dangerously-skip-permissions"
}

# Ask Claude (supports all Claude CLI arguments)
# Usage: cmd_ask [--project <name>] [claude options] "prompt"
cmd_ask() {
    check_lima

    local project=""
    local claude_args=""
    local prompt=""

    # Parse cowork-specific flags first
    while [ $# -gt 0 ]; do
        case "$1" in
            --project|--proj)
                shift
                project="$1"
                shift
                ;;
            *)
                # Collect remaining arguments as Claude args + prompt
                break
                ;;
        esac
    done

    # Everything else goes to Claude
    if [ $# -eq 0 ]; then
        print_error "Usage: cowork ask [--project <name>] [claude options] \"prompt\""
        print_error "Examples:"
        print_error "  cowork ask \"write hello world\""
        print_error "  cowork ask -c \"continue this\""
        print_error "  cowork ask --project myapp \"create a flask app\""
        print_error "  cowork ask --model opus \"complex task\""
        print_error "  cowork ask --max-budget-usd 1.0 \"expensive task\""
        exit 1
    fi

    local status=$(vm_status)
    if [ "$status" != "Running" ]; then
        print_info "Starting VM..."
        cmd_start
    fi

    # Determine actual workspace path in VM
    local vm_workspace="$WORKSPACE"
    if ! limactl shell "$VM_NAME" -- test -d "$WORKSPACE" 2>/dev/null; then
        # Fallback to home-mounted cowork-workspace
        vm_workspace="$HOME/cowork-workspace"
    fi

    # If project is specified, use project directory
    if [ -n "$project" ]; then
        vm_workspace="$vm_workspace/$project"
        # Create project directory if not exists
        limactl shell "$VM_NAME" -- mkdir -p "$vm_workspace"
    fi

    # Build environment variables for Claude API
    local env_vars=""
    if [ -n "$ANTHROPIC_AUTH_TOKEN" ]; then
        env_vars="ANTHROPIC_AUTH_TOKEN='$ANTHROPIC_AUTH_TOKEN' "
    fi
    if [ -n "$ANTHROPIC_BASE_URL" ]; then
        env_vars="${env_vars}ANTHROPIC_BASE_URL='$ANTHROPIC_BASE_URL' "
    fi

    # Pass all arguments to Claude CLI
    # Note: Always use -p (print mode) for non-interactive operation
    # Note: Always use --dangerously-skip-permissions for sandbox
    limactl shell "$VM_NAME" -- bash -c "cd $vm_workspace && ${env_vars}claude -p --dangerously-skip-permissions $(printf '%q ' "$@")"
}

# Execute command in VM
cmd_exec() {
    check_lima

    if [ -z "$1" ]; then
        print_error "Usage: cowork exec \"command\""
        exit 1
    fi

    local status=$(vm_status)
    if [ "$status" != "Running" ]; then
        print_error "VM is not running. Run 'cowork start' first."
        exit 1
    fi

    limactl shell "$VM_NAME" -- bash -c "$*"
}

# Delete VM
cmd_delete() {
    check_lima

    print_info "This will delete the VM and all data inside."
    read -p "Are you sure? (y/N) " -n 1 -r
    echo

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        limactl delete "$VM_NAME" -f 2>/dev/null || true
        print_success "VM deleted"
    else
        print_info "Cancelled"
    fi
}

# Start proxy monitor
cmd_proxy() {
    check_lima

    local log_file=""
    local verbose=""

    # Parse options
    while [ $# -gt 0 ]; do
        case "$1" in
            -l|--log)
                shift
                log_file="$1"
                shift
                ;;
            -v|--verbose)
                verbose="-v"
                shift
                ;;
            *)
                break
                ;;
        esac
    done

    print_header
    print_info "Starting network proxy monitor on port 7890..."
    print_info "This will log all HTTP/HTTPS traffic from the VM"
    print_info "Press Ctrl+C to stop"
    echo ""

    # Build command
    local cmd="python3 $PROJECT_DIR/host/proxy_monitor.py --host 0.0.0.0 --port 7890"
    if [ -n "$log_file" ]; then
        cmd="$cmd --log-file $log_file"
    fi
    if [ -n "$verbose" ]; then
        cmd="$cmd $verbose"
    fi

    # Run proxy monitor
    $cmd
}

# Show help
cmd_help() {
    print_header
    echo ""
    echo "Usage: cowork <command> [arguments]"
    echo ""
    echo "Commands:"
    echo "  init      Initialize/create the sandbox VM"
    echo "  start     Start the sandbox VM"
    echo "  stop      Stop the sandbox VM"
    echo "  status    Show VM status and info"
    echo "  shell     Enter VM shell"
    echo "  claude    Start Claude Code interactively in VM"
    echo "  ask       Ask Claude (non-interactive mode, supports all Claude CLI options)"
    echo "  exec      Execute a command in VM"
    echo "  proxy     Start network proxy monitor (port 7890)"
    echo "  delete    Delete the sandbox VM"
    echo "  help      Show this help message"
    echo ""
    echo "Ask Command Usage:"
    echo "  cowork ask [--project <name>] [claude options] \"prompt\""
    echo ""
    echo "  Cowork-specific options:"
    echo "    --project <name>  Work in project directory (replaces old -p flag)"
    echo "    --proj <name>     Short form of --project"
    echo ""
    echo "  All Claude CLI options are supported, including:"
    echo "    -c, --continue                Continue previous conversation"
    echo "    --model <model>               Use specific model (sonnet/opus/haiku)"
    echo "    --max-budget-usd <amount>     Set budget limit"
    echo "    --system-prompt <prompt>      Custom system prompt"
    echo "    --add-dir <dirs...>           Additional directories"
    echo "    --allowed-tools <tools...>    Specify allowed tools"
    echo "    --json-schema <schema>        Structured output"
    echo "    --mcp-config <configs...>     MCP server configs"
    echo "    ... and many more (see 'claude --help' for full list)"
    echo ""
    echo "Examples:"
    echo "  cowork init                                    # Create and start VM"
    echo "  cowork ask \"write hello world\"                 # New conversation"
    echo "  cowork ask -c \"continue this\"                  # Continue conversation"
    echo "  cowork ask --project myapp \"create flask app\"  # Work in project"
    echo "  cowork ask --project myapp -c \"add tests\"      # Continue in project"
    echo "  cowork ask --model opus \"complex task\"         # Use Opus model"
    echo "  cowork ask --max-budget-usd 1.0 \"task\"         # Set budget limit"
    echo "  cowork ask --system-prompt \"You are X\" \"task\" # Custom prompt"
    echo "  cowork claude                                  # Interactive Claude"
    echo "  cowork exec \"python3 hello.py\"                 # Run command in VM"
    echo "  cowork shell                                   # Enter VM shell"
    echo "  cowork proxy                                   # Monitor network traffic"
    echo "  cowork proxy -l proxy.log -v                   # Monitor with logging"
    echo ""
    echo "Environment variables:"
    echo "  COWORK_VM_NAME        VM name (default: sandbox)"
    echo "  COWORK_WORKSPACE      Workspace path (default: /workspace)"
    echo "  ANTHROPIC_AUTH_TOKEN  API token for Claude Code"
    echo "  ANTHROPIC_BASE_URL    Base URL for Claude API"
    echo ""
    echo "Note: The old '-p <project>' syntax is deprecated. Use '--project <name>' instead."
    echo ""
}

# Main command dispatcher
case "${1:-help}" in
    init)
        cmd_init
        ;;
    start)
        cmd_start
        ;;
    stop)
        cmd_stop
        ;;
    status)
        cmd_status
        ;;
    shell)
        cmd_shell
        ;;
    claude)
        cmd_claude
        ;;
    ask)
        shift
        cmd_ask "$@"
        ;;
    exec)
        shift
        cmd_exec "$@"
        ;;
    proxy)
        shift
        cmd_proxy "$@"
        ;;
    delete)
        cmd_delete
        ;;
    help|--help|-h)
        cmd_help
        ;;
    *)
        print_error "Unknown command: $1"
        cmd_help
        exit 1
        ;;
esac
