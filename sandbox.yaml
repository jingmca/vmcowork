# Lima VM Configuration for Cowork Sandbox
# Reference: Claude Code Cowork mode reverse engineering

# VM Images - Ubuntu 22.04 LTS (Jammy) ARM64
images:
  # Use versioned URL for more reliable downloads
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release-20241004/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
  # Fallback to latest release
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# Resource allocation (matching Cowork mode specs)
cpus: 4
memory: "4GiB"
disk: "10GiB"

# SSH configuration
ssh:
  localPort: 0 # Auto-assign port
  loadDotSSHPubKeys: true

# Mount host directories
mounts:
  - location: "~"
    writable: false
  - location: "/tmp/lima"
    writable: true
  # Workspace for code execution
  - location: "~/cowork-workspace"
    writable: true
    mountPoint: "/workspace"

# Provision scripts - Install required packages
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      echo "=== Cowork Sandbox Setup ==="

      # Update system
      apt-get update
      apt-get upgrade -y

      # Install essential build tools
      apt-get install -y \
        build-essential \
        gcc \
        g++ \
        make \
        cmake \
        git \
        curl \
        wget \
        unzip \
        jq \
        tree \
        htop \
        vim \
        nano

      # Install Python 3.10 + pip
      apt-get install -y \
        python3 \
        python3-pip \
        python3-venv \
        python3-dev

      # Install Node.js 22.x (LTS)
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      apt-get install -y nodejs

      # Install Java 11
      apt-get install -y openjdk-11-jdk

      # Install additional development tools
      apt-get install -y \
        sqlite3 \
        postgresql-client \
        redis-tools \
        ripgrep \
        fd-find \
        bat \
        fzf

      # Install Python packages commonly needed
      pip3 install --upgrade pip
      pip3 install \
        requests \
        httpx \
        aiohttp \
        pydantic \
        pytest \
        black \
        ruff \
        mypy

      # Create workspace directory
      mkdir -p /workspace
      chmod 777 /workspace

      echo "=== Base system setup complete ==="

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      echo "=== Installing Claude Code ==="

      # Install Claude Code CLI
      # Method 1: npm global install
      npm install -g @anthropic-ai/claude-code || true

      # Method 2: If npm fails, try direct install
      if ! command -v claude &> /dev/null; then
        echo "Trying alternative install method..."
        curl -fsSL https://claude.ai/install.sh | sh || true
      fi

      # Verify installation
      which claude || echo "Claude Code not found in PATH"
      claude --version || echo "Claude Code version check failed"

      # Setup shell environment
      echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.bashrc
      echo 'export PATH="$HOME/.npm-global/bin:$PATH"' >> ~/.bashrc

      # Setup proxy environment variables (proxy to host:7890)
      cat >> ~/.bashrc << 'EOF'

      # Proxy configuration - route through host
      export http_proxy="http://192.168.5.2:7890"
      export https_proxy="http://192.168.5.2:7890"
      export HTTP_PROXY="http://192.168.5.2:7890"
      export HTTPS_PROXY="http://192.168.5.2:7890"
      export no_proxy="localhost,127.0.0.1,::1"
      export NO_PROXY="localhost,127.0.0.1,::1"
      EOF

      # Create default workspace
      mkdir -p ~/projects

      echo "=== User setup complete ==="

# Container runtime (disabled - not needed for basic sandbox)
containerd:
  system: false
  user: false

# Port forwarding
portForwards:
  - guestPort: 3000
    hostPort: 3000
  - guestPort: 8000
    hostPort: 8000
  - guestPort: 8080
    hostPort: 8080

# Environment variables in VM
env:
  TERM: xterm-256color
  # Proxy configuration - Lima uses 192.168.5.2 as host gateway
  http_proxy: "http://192.168.5.2:7890"
  https_proxy: "http://192.168.5.2:7890"
  HTTP_PROXY: "http://192.168.5.2:7890"
  HTTPS_PROXY: "http://192.168.5.2:7890"
  no_proxy: "localhost,127.0.0.1,::1"
  NO_PROXY: "localhost,127.0.0.1,::1"
  # Claude Code API configuration (third-party provider)
  ANTHROPIC_AUTH_TOKEN: ""
  ANTHROPIC_BASE_URL: ""

# Propagate proxy settings from host
propagateProxyEnv: false

# Message shown after VM starts
message: |
  Cowork Sandbox VM is ready!

  Quick start:
    limactl shell sandbox
    claude --version

  Proxy configured to host:7890

  Or use the controller:
    python3 host/controller.py "your prompt here"
