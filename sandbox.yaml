# Lima VM Configuration for Cowork Sandbox
# This is a base template - proxy and API configs are injected at runtime

# VM Images - Ubuntu 22.04 LTS (Jammy) ARM64
images:
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release-20241004/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"
  - location: "https://cloud-images.ubuntu.com/releases/22.04/release/ubuntu-22.04-server-cloudimg-arm64.img"
    arch: "aarch64"

# Resource allocation
cpus: 4
memory: "4GiB"
disk: "10GiB"

# SSH configuration
ssh:
  localPort: 0
  loadDotSSHPubKeys: true

# Mount host directories (default workspace, can be overridden)
mounts:
  - location: "~"
    writable: true
    mountPoint: "/tmp/lima"
  - location: "~/Downloads/cowork-workspace"
    writable: true
    mountPoint: "/workspace"

# Provision scripts - Minimal setup for fast boot
provision:
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail

      echo "=== Cowork Sandbox Setup ==="

      # Update package list only (skip upgrade to save time)
      apt-get update

      # Install essential tools
      apt-get install -y --no-install-recommends \
        curl \
        git \
        jq \
        sqlite3 \
        python3 \
        python3-pip \
        python3-venv

      # Install Node.js 22.x (LTS)
      curl -fsSL https://deb.nodesource.com/setup_22.x | bash -
      apt-get install -y nodejs

      # Install Python packages
      pip3 install --upgrade pip
      pip3 install \
        requests \
        httpx \
        aiohttp \
        pydantic \
        pytest \
        black \
        ruff \
        mypy \
        pandas

      # Create workspace directory
      mkdir -p /workspace
      chmod 777 /workspace

      echo "=== System setup complete ==="

  - mode: user
    script: |
      #!/bin/bash
      set -eux -o pipefail

      echo "=== User setup ==="

      # Setup npm global directory
      mkdir -p ~/.npm-global
      npm config set prefix '~/.npm-global'

      # Add to PATH
      if ! grep -q '.npm-global/bin' ~/.bashrc 2>/dev/null; then
        echo 'export PATH="$HOME/.npm-global/bin:$HOME/.local/bin:$PATH"' >> ~/.bashrc
      fi
      export PATH="$HOME/.npm-global/bin:$HOME/.local/bin:$PATH"

      # Install Claude Code CLI
      npm install -g @anthropic-ai/claude-code

      # 检查宿主机的 .vmcowork 目录
      if [ ! -d /tmp/lima/.vmcowork ]; then
        echo "Creating ~/.vmcowork on host for isolated Claude config..."
        mkdir -p /tmp/lima/.vmcowork
      fi

      # 软链 VM 的 ~/.claude 到宿主机的 ~/.vmcowork
      # 这样 VM 的 Claude 配置与宿主机的 ~/.claude 完全隔离
      ln -sfn /tmp/lima/.vmcowork ~/.claude
      echo "Linked ~/.claude -> /tmp/lima/.vmcowork (isolated from host)"

      echo "=== User setup complete ==="

# Container runtime (disabled)
containerd:
  system: false
  user: false

# Port forwarding for development
portForwards:
  - guestPort: 3001
    hostPort: 3001
  - guestPort: 3000
    hostPort: 3000
  - guestPort: 8000
    hostPort: 8000
  - guestPort: 8080
    hostPort: 8080

# Base environment variables
env:
  TERM: xterm-256color

# Do not propagate host proxy settings automatically
propagateProxyEnv: false

# Message shown after VM starts
message: |
  Cowork Sandbox VM is ready!
  Run: cowork status
